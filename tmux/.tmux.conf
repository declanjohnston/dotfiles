# vim:ft=conf:

# Primer: https://danielmiessler.com/study/tmux/
# Tmux for mere mortals: https://zserge.com/posts/tmux/
# gitmux: https://github.com/arl/gitmux

# Source custom Catppuccin colors (must be before catppuccin plugin)
source-file ~/dotfiles/theme/generated/tmux-colors.conf

# Create new panes and windows with current path
bind c new-window -c "#{pane_current_path}"
bind '"' split-window -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"
bind-key -n "M-'" split-window -h -c "#{pane_current_path}"
bind-key -n M-/ split-window -v -c "#{pane_current_path}"
bind-key -n M-n new-window -c "#{pane_current_path}"
bind-key -n M-N new-session -c "#{pane_current_path}"
bind-key -n '<' swap-pane -U
bind-key -n '>' swap-pane -D

# Sidepanel toggle (VSCode-style)
set -g @sidepanel-pane-id ""  # Store the sidepanel pane ID in a user option
set -g @sidepanel-session ""  # Store the sidepanel session name in a user option

# Toggle sidepanel with L (prefix+L)
bind-key L if-shell -F '#{==:#{session_name},sidepanel}' {
    detach-client  # If we're already in the sidepanel session, detach
} {
    if-shell -F '#{session_exists:sidepanel}' {
        attach-session -t sidepanel  # If sidepanel session exists, attach to it
    } {
        display-popup -E -h 95% -w 95% -x C -y 55% "tmux new-session -A -s sidepanel"  # Otherwise create new one
    }
}

# Toggle agents session with F11
bind-key -n F11 if-shell -F '#{==:#{session_name},agents}' {
    detach-client
} {
    if-shell -F '#{session_exists:agents}' {
        display-popup -E -h 99% -w 95% -x C -y S "tmux attach-session -t agents"
    } {
        display-popup -E -h 99% -w 95% -x C -y S "tmux new-session -A -s agents"
    }
}

# Auto-update status bar when switching sessions (for agents session toolbar)
set-hook -g client-session-changed 'run-shell "~/dotfiles/tmux/scripts/update_session_status.sh"'

# Layout and process management
bind-key / next-layout  # Toggle layout
bind-key H display-popup -E -h 95% -w 95% -x C -y C 'htop -t'  # Quick view of processes
bind-key g display-popup -E -h 95% -w 60% -x C -y C 'watch -n 1 nvidia-smi'  # GPU monitoring

# Help and session management
bind-key ? split-window -h 'exec tmux list-keys | fzf-tmux -p80%,80%'  # Help screen
bind-key S command-prompt -p "New session name:" "new-session -s '%%'"  # New session prompt

# Terminal and history settings
set -g default-terminal "tmux-256color"  # Set default terminal
set -g history-limit 100000  # Increase history limit
set -g base-index 1  # Start numbering windows from 1
set-option -g renumber-windows on  # Renumber windows
set -s escape-time 50  # Faster escape sequences

# Popup management
bind -n M-A display-popup -E -h 95% -w 95% -x 5% show-tmux-popup.sh popup1
bind -T popup M-A detach
bind -n M-S display-popup -E -h 95% -w 95% -x 5% show-tmux-popup.sh popup2
bind -T popup M-S detach
bind -T popup C-o copy-mode  # Support detaching from nested session

# Mouse and clipboard settings
set-option -g set-clipboard on
set -g mouse on  # Enable mouse mode
set -g allow-passthrough  # Allow passthrough

# Copy mode settings
bind -T copy-mode-vi v send -X begin-selection
bind P paste-buffer

# Platform-specific clipboard integration
if-shell "uname | grep -q Darwin" {
    # macOS clipboard integration
    bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"
    bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy"
} {
    # Linux clipboard integration
    bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "xclip -selection clipboard -i"
    bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "xclip -selection clipboard -i"
}


# Mouse rectangular selection (hold Shift while dragging)
bind-key -T copy-mode MouseDragEnd1Pane send-keys -X copy-selection-and-cancel
bind-key -T copy-mode S-MouseDrag1Pane send-keys -X begin-selection \; send-keys -X rectangle-toggle
bind-key -T copy-mode-vi S-MouseDrag1Pane send-keys -X begin-selection \; send-keys -X rectangle-toggle


# Status and title settings
set-option -g status-position top
set-option -g status-keys vi
set-option -g set-titles on
set-option -g set-titles-string 'tmux - #W'
set -g bell-action any
set-option -g visual-bell off
setw -g mode-keys vi
setw -g monitor-activity on
set -g visual-activity on
set -g status-interval 2

# Environment settings
setenv -g SHOW_DIRECTORY_NAME 1
set-environment -gu GEM_EDITOR  # Disable possibly set visual editor

# Load local config
if-shell "test -f $HOME/.tmux.conf.local "source $HOME/.tmux.conf.local

# Plugin settings
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'laktak/extrakto'
set -g @plugin 'kristijan/tmux-fzf-pane-switch'

# (Duplicate keybindings removed - already defined above)

# Vim-like key bindings for pane navigation
unbind-key h
bind-key h select-pane -L
unbind-key j
bind-key j select-pane -D
unbind-key k
bind-key k select-pane -U
unbind-key l
bind-key l select-pane -R

# Resizing panes
unbind-key Left
bind-key -r Left resize-pane -L 5
unbind-key Right
bind-key -r Right resize-pane -R 5
unbind-key Down
bind-key -r Down resize-pane -D 5
unbind-key Up
bind-key -r Up resize-pane -U 5

# Window management
bind-key ^space last-window  # Fast toggle between current and last-used window
bind-key p select-layout -o  # Quick way to get back to the previous-used layout
bind-key -r '<' swap-window -d -t '{previous}'  # Move window left
bind-key -r '>' swap-window -d -t '{next}'  # Move window right

# ===================================================================
# Key Table Variables (for F12 toggle functionality)
# Uses theme variables from tmux-colors.conf
# ===================================================================

bind -T root F12  \
  set prefix None \;\
  set key-table off \;\
  set window-status-current-format "#[fg=#{@thm_peach},bg=#{@thm_surface1}]#[fg=#{@thm_crust},bg=#{@thm_peach}] 󰌾 #W #[fg=#{@thm_peach},bg=#{@thm_surface1}]" \;\
  if -F '#{pane_in_mode}' 'send-keys -X cancel' \;\
  refresh-client -S \;\

bind -T off F12 \
  set -u prefix \;\
  set -u key-table \;\
  set -u window-status-current-format \;\
  refresh-client -S

wg_is_keys_off="#{?#{==:#(tmux show-option -qv key-table),off},#[reverse]OFF,}"

# ===================================================================
# Catppuccin Theme Configuration (v2.x)
# Order: 1) Set options, 2) Load plugin, 3) Configure status line
# ===================================================================

# 1. Set Catppuccin options BEFORE loading the plugin
set -g @catppuccin_flavor 'mocha'

# Window styling
set -g @catppuccin_window_status_style "rounded"
set -g @catppuccin_window_number_position "left"
set -g @catppuccin_window_default_fill "all"
set -g @catppuccin_window_default_text "#W"
set -g @catppuccin_window_current_fill "all"
set -g @catppuccin_window_current_text "#W"

# Date/time format
set -g @catppuccin_date_time_text "%I:%M %p"
set -g @catppuccin_date_time_icon "󰃰"

# Session: icon only, no "default" text
set -g @catppuccin_session_text ""

# Pane borders (titles only shown in 'agents' session via hook)
set -g @catppuccin_pane_status_enabled "no"
set -g @catppuccin_pane_border_style "fg=#{@thm_overlay_0}"
set -g @catppuccin_pane_active_border_style "fg=#{@thm_mauve}"
set -g pane-border-status off
set -g pane-border-format "#{?pane_title, #{pane_title} ,}"
set-hook -g after-split-window 'select-pane -T ""'
set-hook -g after-new-window 'select-pane -T ""'

# 2. Load Catppuccin plugin
set -g @plugin 'catppuccin/tmux#v2.1.3'


# Thumbs Plugin Settings
set -g @thumbs-command 'echo -n {} | copy'
set -g @thumbs-reverse enabled
set -g @thumbs-unique enabled

# Plugin and Continuum Settings
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @continuum-restore 'on'
set -g default-command "exec $(which zsh) -l"

# Status and Rename Settings
set-option -g status-interval 5
set-option -g automatic-rename on
set-option -g automatic-rename-format '#{b:pane_current_path}'

# source this file after changes
bind R source-file ~/.tmux.conf \; display "Reloaded .tmux.conf file"

# Auto-install TPM and plugins on first run
if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins'"

run '~/.tmux/plugins/tpm/tpm'

# 4. Configure status line AFTER TPM loads the plugins
set -g status-right-length 300
set -g status-left-length 100

# Status Left: Session with catppuccin styling
set -g status-left "#{E:@catppuccin_status_session}"

# Status Right: Uses Catppuccin theme variables from tmux-colors.conf

# Powerline separators: U+E0B6 (left round), U+E0B4 (right round)
# Status pills - different for local vs SSH sessions
if-shell '[ -z "$SSH_CLIENT" ] && [ -z "$SSH_TTY" ]' {
    # LOCAL machine pills - flowing design (pills connect without gaps)
    # Order: Directory → CPU → RAM → Load → Network | Battery (separate)
    # Directory (lavender) - left cap starts the flow
    set -g  status-right "#[fg=#{@thm_lavender},bg=#{@thm_base}]#[fg=#{@thm_crust},bg=#{@thm_lavender}]  #{b:pane_current_path} "
    # → CPU (peach)
    set -ag status-right "#[fg=#{@thm_peach},bg=#{@thm_lavender}]#[fg=#{@thm_crust},bg=#{@thm_peach}] 󰘚 #(~/dotfiles/tmux/scripts/cpu_status.sh) "
    # → RAM (teal)
    set -ag status-right "#[fg=#{@thm_teal},bg=#{@thm_peach}]#[fg=#{@thm_crust},bg=#{@thm_teal}] 󰍛 #(~/dotfiles/tmux/scripts/ram_status.sh) "
    # → Load (green)
    set -ag status-right "#[fg=#{@thm_green},bg=#{@thm_teal}]#[fg=#{@thm_crust},bg=#{@thm_green}] 󰾥 #(~/dotfiles/tmux/scripts/load_status.sh) "
    # → Network (sapphire) - right cap ends the flow
    set -ag status-right "#[fg=#{@thm_sapphire},bg=#{@thm_green}]#[fg=#{@thm_crust},bg=#{@thm_sapphire}] 󰖩 #(~/dotfiles/tmux/scripts/network_status.sh) #[fg=#{@thm_sapphire},bg=#{@thm_base}]"
    # Battery (separate pill - dynamic color)
    set -ag status-right " #(~/dotfiles/tmux/scripts/battery_status.sh)"


} {
    # SSH/REMOTE machine pills - flowing design (pills connect without gaps)
    # Order: Directory → CPU → RAM → Load → Network | Battery (separate)
    # Directory (lavender) - left cap starts the flow
    set -g  status-right "#[fg=#{@thm_lavender},bg=#{@thm_base}]#[fg=#{@thm_crust},bg=#{@thm_lavender}]  #{b:pane_current_path} "
    # → CPU (peach)
    set -ag status-right "#[fg=#{@thm_peach},bg=#{@thm_lavender}]#[fg=#{@thm_crust},bg=#{@thm_peach}] 󰘚 #(~/dotfiles/tmux/scripts/cpu_status.sh) "
    # → RAM (teal)
    set -ag status-right "#[fg=#{@thm_teal},bg=#{@thm_peach}]#[fg=#{@thm_crust},bg=#{@thm_teal}] 󰍛 #(~/dotfiles/tmux/scripts/ram_status.sh) "
    # → Load (green)
    set -ag status-right "#[fg=#{@thm_green},bg=#{@thm_teal}]#[fg=#{@thm_crust},bg=#{@thm_green}] 󰾥 #(~/dotfiles/tmux/scripts/load_status.sh) "
    # → Network (sapphire) - right cap ends the flow
    set -ag status-right "#[fg=#{@thm_sapphire},bg=#{@thm_green}]#[fg=#{@thm_crust},bg=#{@thm_sapphire}] 󰖩 #(~/dotfiles/tmux/scripts/network_status.sh) #[fg=#{@thm_sapphire},bg=#{@thm_base}]"
    # Battery (separate pill - dynamic color)
    set -ag status-right " #(~/dotfiles/tmux/scripts/battery_status.sh)"

}

# GPU pill (yellow) - only show if nvidia-smi works (not just exists)
if-shell 'nvidia-smi >/dev/null 2>&1' {
    set -ag status-right "#[fg=#{@thm_yellow},bg=#{@thm_base}]#[fg=#{@thm_crust},bg=#{@thm_yellow}] 󰢮 #(~/dotfiles/tmux/scripts/gpu_status.sh) #[fg=#{@thm_yellow},bg=#{@thm_base}]"
}

# Flowing tabs: inactive are flat gray, active pops out with rounded caps
# Active caps transition from/to the gray inactive color for seamless flow
set -gw window-status-current-format "#[fg=#{@thm_mauve},bg=#{@thm_surface1}]#[fg=#{@thm_crust},bg=#{@thm_mauve}] #I #W #[fg=#{@thm_mauve},bg=#{@thm_surface1}]"
set -gw window-status-format "#[fg=#{@thm_text},bg=#{@thm_surface1}] #I #W "
set -gw window-status-separator ""

